(()=>{var e={103(e,t,s){const n=s(398),{formatTime:a,formatTimeHuman:o,getDailyBreakdown:i,getWeeklyBreakdown:r,getMonthlyBreakdown:l,getTimeInRange:c,getStartOfDay:d,getStartOfWeek:h,getStartOfMonth:m,getEndOfDay:u,getEndOfWeek:g,getEndOfMonth:p,aggregateDailyMetrics:v}=s(413),{logger:y}=s(493);e.exports={StatsWebView:class{constructor(e,t){this.context=e,this.storage=t,this.panel=null}show(){if(this.panel)return this.panel.reveal(n.ViewColumn.One),void this.update();this.panel=n.window.createWebviewPanel("workTimerStats","PUNCHCARD - Work Time Statistics",n.ViewColumn.One,{enableScripts:!0,retainContextWhenHidden:!0}),this.panel.webview.html=this.getWebviewContent(),this.panel.webview.onDidReceiveMessage(async e=>{switch(e.command){case"resetProject":"Yes, Reset"===await n.window.showWarningMessage(`Are you sure you want to reset statistics for "${e.projectId}"?`,{modal:!0},"Yes, Reset")&&(await this.storage.resetProject(e.projectId),this.update(),n.window.showInformationMessage(`Statistics for "${e.projectId}" have been reset.`));break;case"resetStat":"Yes, Reset"===await n.window.showWarningMessage(`Are you sure you want to reset ${e.statLabel} for "${e.projectId}"?`,{modal:!0},"Yes, Reset")&&(await this.storage.resetProjectStat(e.projectId,e.statName),this.update(),n.window.showInformationMessage(`${e.statLabel} for "${e.projectId}" has been reset.`));break;case"resetGlobalStat":"Yes, Reset All"===await n.window.showWarningMessage(`Are you sure you want to reset ${e.statLabel} for ALL projects?`,{modal:!0},"Yes, Reset All")&&(await this.storage.resetGlobalStat(e.statName),this.update(),n.window.showInformationMessage(`${e.statLabel} has been reset for all projects.`));break;case"refresh":this.update();break;case"clearLogs":y.clear(),this.update();break;case"forceSyncCheck":await this.storage.checkForSyncedData(),this.update()}},void 0,this.context.subscriptions),this.panel.onDidDispose(()=>{this.panel=null},null,this.context.subscriptions)}update(){this.panel&&(this.panel.webview.html=this.getWebviewContent())}getWebviewContent(){const e=this.storage.getAllData().projects,t=[];for(const s in e)t.push(...e[s].sessions||[]);const s=i(t,7),n=r(t,4),a=l(t,6),o={today:{start:d(),end:u(),label:"Today"},week:{start:h(),end:g(),label:"This Week"},month:{start:m(),end:p(),label:"This Month"},all:{start:0,end:Date.now()+864e5,label:"All Time"}},b={};for(const[t,s]of Object.entries(o)){let n=0,a=0,o=0,i=0,r=0,l=0,d=0,h=0,m=0;const u={};for(const[g,p]of Object.entries(e)){const e=(p.sessions||[]).filter(e=>e.startTime<s.end&&e.endTime>s.start),y=c(p.sessions||[],s.start,s.end);let b;"all"===t?b={time:p.totalTime||0,keystrokes:p.keystrokes||0,linesAdded:p.linesAdded||0,linesDeleted:p.linesDeleted||0,linesAddedBulk:p.linesAddedBulk||0,linesDeletedBulk:p.linesDeletedBulk||0,charactersAdded:p.charactersAdded||0,charactersDeleted:p.charactersDeleted||0}:(b=v(p.dailyMetrics||{},s.start,s.end),b.time=y),u[g]={...b,sessions:e.length,lastActive:p.lastActive||0},n+=b.time,a+=b.keystrokes,o+=b.linesAdded,i+=b.linesDeleted,r+=b.linesAddedBulk,l+=b.linesDeletedBulk,d+=b.charactersAdded,h+=b.charactersDeleted,m+=e.length}b[t]={label:s.label,summary:{totalTime:n,totalKeystrokes:a,totalSessions:m,totalLinesAdded:o,totalLinesDeleted:i,totalLinesAddedBulk:r,totalLinesDeletedBulk:l,totalCharsAdded:d,totalCharsDeleted:h,projectCount:Object.keys(e).length},projects:u}}const f=this.storage.getSyncInfo?this.storage.getSyncInfo():{},k=y.getLogs(),S=Object.entries(e).map(([e,t])=>({id:e,lastActive:t.lastActive})).sort((e,t)=>(t.lastActive||0)-(e.lastActive||0));return`<!DOCTYPE html>\n<html lang="en">\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>PUNCHCARD - Work Time Statistics</title>\n    <script src="https://cdn.jsdelivr.net/npm/chart.js"><\/script>\n    <style>\n        :root {\n            --bg-color: var(--vscode-editor-background);\n            --text-color: var(--vscode-editor-foreground);\n            --border-color: var(--vscode-panel-border);\n            --card-bg: var(--vscode-editorWidget-background);\n            --accent-color: var(--vscode-button-background);\n            --accent-hover: var(--vscode-button-hoverBackground);\n            --danger-color: var(--vscode-errorForeground);\n        }\n\n        * { margin: 0; padding: 0; box-sizing: border-box; }\n\n        body {\n            font-family: var(--vscode-font-family);\n            background-color: var(--bg-color);\n            color: var(--text-color);\n            padding: 20px;\n            line-height: 1.6;\n        }\n\n        h1, h2, h3 { margin-bottom: 15px; font-weight: 600; }\n        h1 { font-size: 24px; display: flex; align-items: center; gap: 10px; }\n        h1::before { content: "‚è±Ô∏è"; }\n\n        .header {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            margin-bottom: 20px;\n            padding-bottom: 15px;\n            border-bottom: 1px solid var(--border-color);\n        }\n\n        .header-actions { display: flex; gap: 10px; align-items: center; }\n\n        .refresh-btn {\n            background-color: var(--card-bg);\n            color: var(--text-color);\n            border: 1px solid var(--border-color);\n            padding: 8px 16px;\n            border-radius: 4px;\n            cursor: pointer;\n            font-size: 13px;\n            transition: all 0.15s;\n        }\n\n        .refresh-btn:hover {\n            background-color: var(--accent-hover);\n            color: var(--vscode-button-foreground);\n            border-color: var(--accent-hover);\n        }\n\n        .period-btn {\n            background-color: transparent;\n            color: var(--text-color);\n            border: 1px solid transparent;\n            padding: 8px 16px;\n            border-radius: 4px;\n            cursor: pointer;\n            font-size: 13px;\n            transition: background-color 0.15s, color 0.15s;\n        }\n\n        .period-btn:hover {\n            background-color: rgba(128, 128, 128, 0.15);\n        }\n\n        .period-tabs {\n            display: flex;\n            gap: 4px;\n            margin-bottom: 25px;\n            padding: 4px;\n            background-color: var(--card-bg);\n            border-radius: 8px;\n            border: 1px solid var(--border-color);\n            width: fit-content;\n        }\n\n        .period-btn.active {\n            background-color: var(--accent-color);\n            color: var(--vscode-button-foreground);\n            border-color: transparent;\n        }\n\n        .summary-grid {\n            display: grid;\n            grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));\n            gap: 12px;\n            margin-bottom: 30px;\n        }\n\n        .summary-card {\n            background-color: var(--card-bg);\n            border: 1px solid var(--border-color);\n            border-radius: 8px;\n            padding: 18px;\n            text-align: center;\n            position: relative;\n        }\n\n        .summary-card:hover .summary-reset-btn { opacity: 1; }\n\n        .summary-reset-btn {\n            position: absolute; top: 5px; right: 5px;\n            background: transparent; border: none;\n            color: var(--danger-color); cursor: pointer;\n            font-size: 10px; padding: 2px 6px;\n            opacity: 0; transition: opacity 0.2s; border-radius: 3px;\n        }\n        .summary-reset-btn:hover { background-color: var(--danger-color); color: white; }\n\n        .summary-card .value {\n            font-size: 26px;\n            font-weight: bold;\n            color: var(--accent-color);\n            margin-bottom: 4px;\n        }\n\n        .summary-card .label {\n            font-size: 11px;\n            opacity: 0.8;\n            text-transform: uppercase;\n        }\n\n        .charts-container {\n            display: grid;\n            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));\n            gap: 20px;\n            margin-bottom: 30px;\n        }\n\n        .chart-card {\n            background-color: var(--card-bg);\n            border: 1px solid var(--border-color);\n            border-radius: 8px;\n            padding: 20px;\n        }\n        .chart-card h3 { margin-bottom: 20px; }\n        .chart-container { position: relative; height: 250px; }\n\n        .projects-section { margin-top: 30px; }\n\n        .project-card {\n            background-color: var(--card-bg);\n            border: 1px solid var(--border-color);\n            border-radius: 8px;\n            padding: 20px;\n            margin-bottom: 15px;\n        }\n\n        .project-header {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            margin-bottom: 15px;\n        }\n\n        .project-name { font-size: 18px; font-weight: 600; }\n\n        .reset-btn {\n            background-color: transparent;\n            color: var(--danger-color);\n            border: 1px solid var(--danger-color);\n            padding: 5px 10px; border-radius: 4px;\n            cursor: pointer; font-size: 12px;\n        }\n        .reset-btn:hover { background-color: var(--danger-color); color: white; }\n\n        .project-stats {\n            display: grid;\n            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));\n            gap: 10px;\n        }\n\n        .stat { display: flex; flex-direction: column; position: relative; }\n        .stat:hover .stat-reset-btn { opacity: 1; }\n\n        .stat-reset-btn {\n            position: absolute; top: 0; right: 0;\n            background: transparent; border: none;\n            color: var(--danger-color); cursor: pointer;\n            font-size: 10px; padding: 2px 5px;\n            opacity: 0; transition: opacity 0.2s; border-radius: 3px;\n        }\n        .stat-reset-btn:hover { background-color: var(--danger-color); color: white; }\n\n        .stat .stat-value { font-size: 18px; font-weight: bold; }\n        .stat .stat-label { font-size: 10px; opacity: 0.7; text-transform: uppercase; }\n\n        .no-data { text-align: center; padding: 40px; opacity: 0.6; }\n\n        .period-badge {\n            display: inline-block;\n            font-size: 11px;\n            padding: 2px 8px;\n            border-radius: 10px;\n            background-color: var(--accent-color);\n            color: var(--vscode-button-foreground);\n            margin-left: 10px;\n            vertical-align: middle;\n        }\n\n        @media (max-width: 600px) {\n            .charts-container { grid-template-columns: 1fr; }\n        }\n\n        /* Sync & Debug Log Styles */\n        .sync-log-section {\n            margin-top: 30px;\n            border: 1px solid var(--border-color);\n            border-radius: 8px;\n            overflow: hidden;\n        }\n        .sync-log-header {\n            display: flex; justify-content: space-between; align-items: center;\n            padding: 15px 20px; cursor: pointer;\n            background-color: var(--card-bg); user-select: none;\n        }\n        .sync-log-header:hover { opacity: 0.9; }\n        .sync-log-header h2 { margin-bottom: 0; font-size: 16px; }\n        .sync-log-toggle { font-size: 14px; transition: transform 0.2s; }\n        .sync-log-toggle.open { transform: rotate(90deg); }\n        .sync-log-content { padding: 20px; display: none; }\n        .sync-log-content.visible { display: block; }\n        .sync-info-grid {\n            display: grid;\n            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));\n            gap: 10px; margin-bottom: 20px;\n        }\n        .sync-info-card {\n            background-color: var(--card-bg);\n            border: 1px solid var(--border-color);\n            border-radius: 6px; padding: 12px; text-align: center;\n        }\n        .sync-info-value {\n            font-size: 14px; font-weight: bold;\n            color: var(--accent-color); margin-bottom: 4px; word-break: break-all;\n        }\n        .sync-info-label { font-size: 10px; opacity: 0.7; text-transform: uppercase; }\n        .log-controls {\n            display: flex; gap: 10px; margin-bottom: 15px;\n            align-items: center; flex-wrap: wrap;\n        }\n        .log-controls select {\n            background-color: var(--card-bg); color: var(--text-color);\n            border: 1px solid var(--border-color); padding: 5px 10px;\n            border-radius: 4px; font-size: 12px;\n        }\n        .log-controls .clear-btn {\n            background-color: transparent; color: var(--danger-color);\n            border: 1px solid var(--danger-color); padding: 5px 10px;\n            border-radius: 4px; cursor: pointer; font-size: 12px;\n        }\n        .log-controls .clear-btn:hover { background-color: var(--danger-color); color: white; }\n        .log-controls .sync-check-btn {\n            background-color: var(--accent-color); color: var(--vscode-button-foreground);\n            border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;\n        }\n        .log-controls .sync-check-btn:hover { background-color: var(--accent-hover); }\n        .log-entries {\n            max-height: 400px; overflow-y: auto;\n            font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;\n            font-size: 11px; line-height: 1.4;\n            background-color: var(--bg-color);\n            border: 1px solid var(--border-color); border-radius: 4px; padding: 10px;\n        }\n        .log-entry { padding: 2px 0; border-bottom: 1px solid rgba(128,128,128,0.1); }\n        .log-entry:last-child { border-bottom: none; }\n        .log-time { color: #888; margin-right: 8px; }\n        .log-level { font-weight: bold; margin-right: 6px; display: inline-block; min-width: 50px; }\n        .log-level.info { color: #4FC3F7; }\n        .log-level.warn { color: #FFB74D; }\n        .log-level.error { color: #EF5350; }\n        .log-level.debug { color: #888; }\n        .log-category { color: #BA68C8; margin-right: 6px; }\n        .log-message { color: var(--text-color); }\n        .log-data { color: #888; font-size: 10px; margin-left: 20px; white-space: pre-wrap; display: none; }\n        .log-entry:hover .log-data { display: block; }\n        .log-count { font-size: 11px; opacity: 0.6; margin-left: 10px; }\n    </style>\n</head>\n<body>\n    <div class="header">\n        <h1>PUNCHCARD - Work Time Statistics</h1>\n        <div class="header-actions">\n            <button class="refresh-btn" onclick="refresh()">üîÑ Refresh</button>\n        </div>\n    </div>\n\n    \x3c!-- Period Selector Tabs --\x3e\n    <div class="period-tabs">\n        <button class="period-btn active" data-period="all" onclick="switchPeriod('all')">All Time</button>\n        <button class="period-btn" data-period="month" onclick="switchPeriod('month')">This Month</button>\n        <button class="period-btn" data-period="week" onclick="switchPeriod('week')">This Week</button>\n        <button class="period-btn" data-period="today" onclick="switchPeriod('today')">Today</button>\n    </div>\n\n    \x3c!-- Summary (rendered by JS) --\x3e\n    <div class="summary-grid" id="summaryGrid"></div>\n\n    \x3c!-- Charts --\x3e\n    <div class="charts-container">\n        <div class="chart-card">\n            <h3>üìÖ Daily Activity (Last 7 Days)</h3>\n            <div class="chart-container"><canvas id="dailyChart"></canvas></div>\n        </div>\n        <div class="chart-card">\n            <h3>üìä Weekly Activity (Last 4 Weeks)</h3>\n            <div class="chart-container"><canvas id="weeklyChart"></canvas></div>\n        </div>\n        <div class="chart-card">\n            <h3>üìà Monthly Activity (Last 6 Months)</h3>\n            <div class="chart-container"><canvas id="monthlyChart"></canvas></div>\n        </div>\n        <div class="chart-card">\n            <h3>ü•ß Time by Project</h3>\n            <div class="chart-container"><canvas id="projectsChart"></canvas></div>\n        </div>\n    </div>\n\n    \x3c!-- Projects (rendered by JS) --\x3e\n    <div class="projects-section">\n        <h2>üìÅ Projects <span class="period-badge" id="periodBadge">All Time</span></h2>\n        <div id="projectsContainer"></div>\n    </div>\n\n    \x3c!-- Sync & Debug Log Section --\x3e\n    <div class="sync-log-section">\n        <div class="sync-log-header" onclick="toggleSyncLog()">\n            <h2>üîß Sync & Debug Log</h2>\n            <span class="sync-log-toggle" id="syncLogToggle">‚ñ∂</span>\n        </div>\n        <div class="sync-log-content" id="syncLogContent">\n            <div class="sync-info-grid">\n                <div class="sync-info-card">\n                    <div class="sync-info-value">${f.machineId||"N/A"}</div>\n                    <div class="sync-info-label">Machine ID</div>\n                </div>\n                <div class="sync-info-card">\n                    <div class="sync-info-value">${f.lastSaveTime?new Date(f.lastSaveTime).toLocaleString():"Never"}</div>\n                    <div class="sync-info-label">Last Save</div>\n                </div>\n                <div class="sync-info-card">\n                    <div class="sync-info-value">${f.totalSaves||0}</div>\n                    <div class="sync-info-label">Total Saves</div>\n                </div>\n                <div class="sync-info-card">\n                    <div class="sync-info-value">${f.syncDetections||0}</div>\n                    <div class="sync-info-label">Sync Events Detected</div>\n                </div>\n                <div class="sync-info-card">\n                    <div class="sync-info-value">${f.totalMerges||0}</div>\n                    <div class="sync-info-label">Data Merges</div>\n                </div>\n                <div class="sync-info-card">\n                    <div class="sync-info-value">${f.totalSessions||0}</div>\n                    <div class="sync-info-label">Total Sessions</div>\n                </div>\n                <div class="sync-info-card">\n                    <div class="sync-info-value">${Object.entries(f.sessionsByMachine||{}).map(([e,t])=>e.substring(0,15)+": "+t).join("<br>")||"N/A"}</div>\n                    <div class="sync-info-label">Sessions by Machine</div>\n                </div>\n            </div>\n            <div class="log-controls">\n                <select id="logFilter" onchange="filterLogs()">\n                    <option value="all">All Categories</option>\n                    <option value="sync">Sync</option>\n                    <option value="storage">Storage</option>\n                    <option value="tracker">Tracker</option>\n                    <option value="session">Session</option>\n                    <option value="merge">Merge</option>\n                    <option value="init">Init</option>\n                </select>\n                <select id="logLevelFilter" onchange="filterLogs()">\n                    <option value="all">All Levels</option>\n                    <option value="error">Errors Only</option>\n                    <option value="warn">Warnings & Errors</option>\n                    <option value="info">Info & Above</option>\n                </select>\n                <button class="sync-check-btn" onclick="forceSyncCheck()">üîÑ Force Sync Check</button>\n                <button class="clear-btn" onclick="clearLogs()">üóëÔ∏è Clear Logs</button>\n                <span class="log-count">${k.length} entries</span>\n            </div>\n            <div class="log-entries" id="logEntries">\n                ${0===k.length?'<div style="opacity:0.5; text-align:center; padding:20px;">No log entries yet. Logs will appear as sync events occur.</div>':k.slice().reverse().map(e=>{const t=new Date(e.timestamp).toLocaleTimeString();return`<div class="log-entry" data-category="${e.category}" data-level="${e.level}">\n                            <span class="log-time">${t}</span>\n                            <span class="log-level ${e.level}">[${e.level.toUpperCase()}]</span>\n                            <span class="log-category">[${e.category}]</span>\n                            <span class="log-message">${this.escapeHtml(e.message)}</span>\n                            ${e.data?`<div class="log-data">${this.escapeHtml(e.data)}</div>`:""}\n                        </div>`}).join("")}\n            </div>\n        </div>\n    </div>\n\n    <script>\n        const vscode = acquireVsCodeApi();\n        const periodData = ${JSON.stringify(b)};\n        const projectList = ${JSON.stringify(S)};\n        let currentPeriod = 'all';\n\n        function fmtTime(ms) {\n            if (ms < 0) ms = 0;\n            const s = Math.floor(ms / 1000);\n            const h = Math.floor(s / 3600);\n            const m = Math.floor((s % 3600) / 60);\n            const sec = s % 60;\n            return h.toString().padStart(2,'0') + ':' + m.toString().padStart(2,'0') + ':' + sec.toString().padStart(2,'0');\n        }\n\n        function fmtNum(n) { return (n || 0).toLocaleString(); }\n\n        function esc(text) {\n            const d = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'": '&#039;'};\n            return String(text).replace(/[&<>"']/g, m => d[m]);\n        }\n\n        function switchPeriod(period) {\n            currentPeriod = period;\n            document.querySelectorAll('.period-btn').forEach(btn => {\n                btn.classList.toggle('active', btn.getAttribute('data-period') === period);\n            });\n            renderSummary();\n            renderProjects();\n        }\n\n        function renderSummary() {\n            const pd = periodData[currentPeriod];\n            if (!pd) return;\n            const s = pd.summary;\n            const grid = document.getElementById('summaryGrid');\n            grid.innerHTML = \`\n                <div class="summary-card">\n                    <button class="summary-reset-btn" onclick="resetGlobalStat('totalTime', 'Total Time')">‚úï</button>\n                    <div class="value">\${fmtTime(s.totalTime)}</div>\n                    <div class="label">Time (\${pd.label})</div>\n                </div>\n                <div class="summary-card">\n                    <div class="value">\${s.projectCount}</div>\n                    <div class="label">Projects</div>\n                </div>\n                <div class="summary-card">\n                    <button class="summary-reset-btn" onclick="resetGlobalStat('sessions', 'Sessions')">‚úï</button>\n                    <div class="value">\${fmtNum(s.totalSessions)}</div>\n                    <div class="label">Sessions</div>\n                </div>\n                <div class="summary-card">\n                    <button class="summary-reset-btn" onclick="resetGlobalStat('keystrokes', 'Keystrokes')">‚úï</button>\n                    <div class="value">\${fmtNum(s.totalKeystrokes)}</div>\n                    <div class="label">Keystrokes</div>\n                </div>\n                <div class="summary-card">\n                    <button class="summary-reset-btn" onclick="resetGlobalStat('linesAdded', 'Lines Added (Typed)')">‚úï</button>\n                    <div class="value">+\${fmtNum(s.totalLinesAdded)}</div>\n                    <div class="label">Lines Added (Typed)</div>\n                </div>\n                <div class="summary-card">\n                    <button class="summary-reset-btn" onclick="resetGlobalStat('linesDeleted', 'Lines Deleted (Typed)')">‚úï</button>\n                    <div class="value">-\${fmtNum(s.totalLinesDeleted)}</div>\n                    <div class="label">Lines Deleted (Typed)</div>\n                </div>\n                <div class="summary-card">\n                    <button class="summary-reset-btn" onclick="resetGlobalStat('linesAddedBulk', 'Lines Added (Bulk)')">‚úï</button>\n                    <div class="value">+\${fmtNum(s.totalLinesAddedBulk)}</div>\n                    <div class="label">Lines Added (Bulk/Paste)</div>\n                </div>\n                <div class="summary-card">\n                    <button class="summary-reset-btn" onclick="resetGlobalStat('charactersAdded', 'Characters Added')">‚úï</button>\n                    <div class="value">\${fmtNum(s.totalCharsAdded)}</div>\n                    <div class="label">Chars Added</div>\n                </div>\n                <div class="summary-card">\n                    <button class="summary-reset-btn" onclick="resetGlobalStat('charactersDeleted', 'Characters Deleted')">‚úï</button>\n                    <div class="value">\${fmtNum(s.totalCharsDeleted)}</div>\n                    <div class="label">Chars Deleted</div>\n                </div>\n            \`;\n        }\n\n        function renderProjects() {\n            const pd = periodData[currentPeriod];\n            if (!pd) return;\n            const container = document.getElementById('projectsContainer');\n            const badge = document.getElementById('periodBadge');\n            badge.textContent = pd.label;\n\n            if (projectList.length === 0) {\n                container.innerHTML = '<div class="no-data">No projects tracked yet. Start coding to see your statistics!</div>';\n                return;\n            }\n\n            container.innerHTML = projectList.map(proj => {\n                const s = pd.projects[proj.id] || {};\n                return \`\n                <div class="project-card">\n                    <div class="project-header">\n                        <span class="project-name">\${esc(proj.id)}</span>\n                        <button class="reset-btn" onclick="resetProject('\${esc(proj.id)}')">üóëÔ∏è Reset All</button>\n                    </div>\n                    <div class="project-stats">\n                        <div class="stat">\n                            <span class="stat-value">\${fmtTime(s.time || 0)}</span>\n                            <span class="stat-label">Time</span>\n                            <button class="stat-reset-btn" onclick="resetStat('\${esc(proj.id)}', 'totalTime', 'Total Time')">‚úï</button>\n                        </div>\n                        <div class="stat">\n                            <span class="stat-value">\${fmtNum(s.sessions)}</span>\n                            <span class="stat-label">Sessions</span>\n                            <button class="stat-reset-btn" onclick="resetStat('\${esc(proj.id)}', 'sessions', 'Sessions')">‚úï</button>\n                        </div>\n                        <div class="stat">\n                            <span class="stat-value">\${fmtNum(s.keystrokes)}</span>\n                            <span class="stat-label">Keystrokes</span>\n                            <button class="stat-reset-btn" onclick="resetStat('\${esc(proj.id)}', 'keystrokes', 'Keystrokes')">‚úï</button>\n                        </div>\n                        <div class="stat">\n                            <span class="stat-value">+\${fmtNum(s.linesAdded)}</span>\n                            <span class="stat-label">Lines (Typed)</span>\n                            <button class="stat-reset-btn" onclick="resetStat('\${esc(proj.id)}', 'linesAdded', 'Lines Added')">‚úï</button>\n                        </div>\n                        <div class="stat">\n                            <span class="stat-value">-\${fmtNum(s.linesDeleted)}</span>\n                            <span class="stat-label">Lines Del (Typed)</span>\n                            <button class="stat-reset-btn" onclick="resetStat('\${esc(proj.id)}', 'linesDeleted', 'Lines Deleted')">‚úï</button>\n                        </div>\n                        <div class="stat">\n                            <span class="stat-value">+\${fmtNum(s.linesAddedBulk)}</span>\n                            <span class="stat-label">Lines (Bulk)</span>\n                            <button class="stat-reset-btn" onclick="resetStat('\${esc(proj.id)}', 'linesAddedBulk', 'Lines Added (Bulk)')">‚úï</button>\n                        </div>\n                        <div class="stat">\n                            <span class="stat-value">\${fmtNum(s.charactersAdded)}</span>\n                            <span class="stat-label">Chars Added</span>\n                            <button class="stat-reset-btn" onclick="resetStat('\${esc(proj.id)}', 'charactersAdded', 'Chars Added')">‚úï</button>\n                        </div>\n                        <div class="stat">\n                            <span class="stat-value">\${fmtNum(s.charactersDeleted)}</span>\n                            <span class="stat-label">Chars Deleted</span>\n                            <button class="stat-reset-btn" onclick="resetStat('\${esc(proj.id)}', 'charactersDeleted', 'Chars Deleted')">‚úï</button>\n                        </div>\n                        <div class="stat">\n                            <span class="stat-value">\${s.lastActive ? new Date(s.lastActive).toLocaleDateString() : 'Never'}</span>\n                            <span class="stat-label">Last Active</span>\n                        </div>\n                    </div>\n                </div>\n                \`;\n            }).join('');\n        }\n\n        // Initial render\n        renderSummary();\n        renderProjects();\n\n        function refresh() { vscode.postMessage({ command: 'refresh' }); }\n        function resetProject(projectId) { vscode.postMessage({ command: 'resetProject', projectId }); }\n        function resetStat(projectId, statName, statLabel) { vscode.postMessage({ command: 'resetStat', projectId, statName, statLabel }); }\n        function resetGlobalStat(statName, statLabel) { vscode.postMessage({ command: 'resetGlobalStat', statName, statLabel }); }\n\n        // Sync log\n        function toggleSyncLog() {\n            const content = document.getElementById('syncLogContent');\n            const toggle = document.getElementById('syncLogToggle');\n            content.classList.toggle('visible');\n            toggle.classList.toggle('open');\n        }\n        function filterLogs() {\n            const catFilter = document.getElementById('logFilter').value;\n            const lvlFilter = document.getElementById('logLevelFilter').value;\n            const lvlOrder = { 'error': 0, 'warn': 1, 'info': 2, 'debug': 3 };\n            document.querySelectorAll('.log-entry').forEach(entry => {\n                const cat = entry.getAttribute('data-category');\n                const lvl = entry.getAttribute('data-level');\n                const showCat = catFilter === 'all' || cat === catFilter;\n                let showLvl = true;\n                if (lvlFilter === 'error') showLvl = lvl === 'error';\n                else if (lvlFilter === 'warn') showLvl = lvlOrder[lvl] <= 1;\n                else if (lvlFilter === 'info') showLvl = lvlOrder[lvl] <= 2;\n                entry.style.display = (showCat && showLvl) ? '' : 'none';\n            });\n        }\n        function clearLogs() { vscode.postMessage({ command: 'clearLogs' }); }\n        function forceSyncCheck() { vscode.postMessage({ command: 'forceSyncCheck' }); }\n\n        // Chart.js\n        Chart.defaults.color = getComputedStyle(document.body).getPropertyValue('--vscode-editor-foreground') || '#ffffff';\n        Chart.defaults.borderColor = getComputedStyle(document.body).getPropertyValue('--vscode-panel-border') || '#333333';\n\n        const chartColors = ['#4FC3F7','#81C784','#FFB74D','#F06292','#BA68C8','#4DD0E1','#AED581','#FF8A65','#9575CD','#7986CB'];\n\n        const dailyData = ${JSON.stringify(s)};\n        new Chart(document.getElementById('dailyChart'), {\n            type: 'bar',\n            data: { labels: dailyData.map(d => d.date), datasets: [{ label: 'Hours', data: dailyData.map(d => (d.time/3600000).toFixed(2)), backgroundColor: '#4FC3F7', borderRadius: 4 }] },\n            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'Hours' } } } }\n        });\n\n        const weeklyData = ${JSON.stringify(n)};\n        new Chart(document.getElementById('weeklyChart'), {\n            type: 'bar',\n            data: { labels: weeklyData.map(d => d.week), datasets: [{ label: 'Hours', data: weeklyData.map(d => (d.time/3600000).toFixed(2)), backgroundColor: '#81C784', borderRadius: 4 }] },\n            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'Hours' } } } }\n        });\n\n        const monthlyData = ${JSON.stringify(a)};\n        new Chart(document.getElementById('monthlyChart'), {\n            type: 'line',\n            data: { labels: monthlyData.map(d => d.month), datasets: [{ label: 'Hours', data: monthlyData.map(d => (d.time/3600000).toFixed(2)), borderColor: '#FFB74D', backgroundColor: 'rgba(255,183,77,0.2)', fill: true, tension: 0.3 }] },\n            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'Hours' } } } }\n        });\n\n        const projectsData = ${JSON.stringify(Object.entries(e).map(([e,t])=>({name:e,time:t.totalTime})))};\n        if (projectsData.length > 0) {\n            new Chart(document.getElementById('projectsChart'), {\n                type: 'doughnut',\n                data: { labels: projectsData.map(d => d.name), datasets: [{ data: projectsData.map(d => (d.time/3600000).toFixed(2)), backgroundColor: chartColors.slice(0, projectsData.length) }] },\n                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 12, padding: 10 } } } }\n            });\n        }\n    <\/script>\n</body>\n</html>`}formatNumber(e){return e.toLocaleString()}escapeHtml(e){const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,e=>t[e])}dispose(){this.panel&&(this.panel.dispose(),this.panel=null)}}}},140(e,t,s){const n=s(398),{getProjectId:a}=s(413),{createEmptyProjectStats:o}=s(305),{logger:i}=s(493);e.exports={Tracker:class{constructor(e){this.storage=e,this.projectId=a(),this.isTracking=!1,this.lastActivity=Date.now(),this.sessionStartTime=0,this.currentSessionTime=0,this.isAfk=!1,this.afkThreshold=3e5,this.checkInterval=null,this.disposables=[],this.onTimeUpdateCallback=null,this.onAfkChangeCallback=null}initialize(){this.loadConfig(),this.disposables.push(n.workspace.onDidChangeConfiguration(e=>{e.affectsConfiguration("punchcardWorkTimer")&&this.loadConfig()})),n.workspace.getConfiguration("punchcardWorkTimer").get("trackOnStartup",!0)&&this.start()}loadConfig(){const e=n.workspace.getConfiguration("punchcardWorkTimer");this.afkThreshold=e.get("afkThreshold",3e5)}start(){this.isTracking||(this.isTracking=!0,this.lastActivity=Date.now(),this.sessionStartTime=Date.now(),this.currentSessionTime=0,this.isAfk=!1,this.registerActivityListeners(),this.checkInterval=setInterval(()=>this.tick(),1e3),this.storage.addSession(this.projectId,{startTime:this.sessionStartTime,endTime:this.sessionStartTime,duration:0}),i.info("tracker",`Tracking started for project: ${this.projectId}`,{sessionStartTime:this.sessionStartTime}))}stop(){if(this.isTracking&&(this.isTracking=!1,this.checkInterval&&(clearInterval(this.checkInterval),this.checkInterval=null),this.disposeActivityListeners(),this.sessionStartTime>0)){const e=Date.now();this.storage.updateLastSession(this.projectId,this.sessionStartTime,e,this.currentSessionTime),this.storage._saveImmediate(),i.info("tracker",`Tracking stopped for ${this.projectId}. Session duration: ${this.currentSessionTime}ms`)}}registerActivityListeners(){this.disposables.push(n.workspace.onDidChangeTextDocument(e=>{this.onActivity(),this.trackDocumentChanges(e)})),this.disposables.push(n.window.onDidChangeTextEditorSelection(()=>{this.onActivity()})),this.disposables.push(n.window.onDidChangeTextEditorVisibleRanges(()=>{this.onActivity()})),this.disposables.push(n.window.onDidChangeActiveTextEditor(()=>{this.onActivity(),this.projectId=a()}))}disposeActivityListeners(){for(const e of this.disposables)e.dispose();this.disposables=[]}onActivity(){const e=this.isAfk;this.lastActivity=Date.now(),this.isAfk=!1,e&&this.onAfkChangeCallback&&(this.onAfkChangeCallback(!1),this.sessionStartTime=Date.now(),this.currentSessionTime=0,this.storage.addSession(this.projectId,{startTime:this.sessionStartTime,endTime:this.sessionStartTime,duration:0}),i.info("tracker",`Returned from AFK, new session started for ${this.projectId}`))}trackDocumentChanges(e){if(!e.contentChanges.length)return;let t=0,s=0,n=0,a=0,o=0,i=0,r=0;for(const l of e.contentChanges){const e=l.text.length,c=l.rangeLength;n+=e,a+=c;const d=(l.text.match(/\n/g)||[]).length,h=l.range.end.line-l.range.start.line;e>10||c>10||d>3||h>3?(i+=d,r+=h):(t+=d,s+=h,(0===e&&c>0||e>0)&&(o+=1))}(o>0||n>0||a>0||t>0||s>0||i>0||r>0)&&this.storage.addMetrics(this.projectId,{linesAdded:t,linesDeleted:s,linesAddedBulk:i,linesDeletedBulk:r,charactersAdded:n,charactersDeleted:a,keystrokes:o})}tick(){if(!this.isTracking)return;const e=Date.now(),t=e-this.lastActivity;t>=this.afkThreshold?this.isAfk||(this.isAfk=!0,this.storage.updateLastSession(this.projectId,this.sessionStartTime,this.lastActivity,this.currentSessionTime),this.storage._saveImmediate(),i.info("tracker",`AFK detected for ${this.projectId} after ${t}ms inactivity. Session time: ${this.currentSessionTime}ms`),this.onAfkChangeCallback&&this.onAfkChangeCallback(!0)):this.isAfk||(this.currentSessionTime+=1e3,this.storage.addTime(this.projectId,1e3),this.storage.updateLastSession(this.projectId,this.sessionStartTime,e,this.currentSessionTime),this.onTimeUpdateCallback&&this.onTimeUpdateCallback(this.currentSessionTime))}onTimeUpdate(e){this.onTimeUpdateCallback=e}onAfkChange(e){this.onAfkChangeCallback=e}getCurrentSessionTime(){return this.currentSessionTime}getTodayTime(){const e=this.storage.getProjectStats(this.projectId),t=new Date;t.setHours(0,0,0,0);const s=t.getTime();Date.now();let n=0;for(const t of e.sessions)t.startTime>=s?n+=t.duration:t.endTime>s&&(n+=t.endTime-s);return n}isCurrentlyTracking(){return this.isTracking&&!this.isAfk}getProjectId(){return this.projectId}dispose(){this.stop(),this.disposeActivityListeners()}}}},305(e){e.exports={createEmptyProjectStats:function(){return{totalTime:0,linesAdded:0,linesDeleted:0,linesAddedBulk:0,linesDeletedBulk:0,charactersAdded:0,charactersDeleted:0,keystrokes:0,sessions:[],lastActive:0,dailyMetrics:{}}},createEmptyStorageData:function(){return{projects:{},totalTimeAllProjects:0,totalKeystrokes:0}},createEmptyDailyMetrics:function(){return{time:0,keystrokes:0,linesAdded:0,linesDeleted:0,linesAddedBulk:0,linesDeletedBulk:0,charactersAdded:0,charactersDeleted:0}}}},398(e){"use strict";e.exports=require("vscode")},413(e,t,s){const n=s(398);function a(){const e=new Date;return new Date(e.getFullYear(),e.getMonth(),e.getDate()).getTime()}function o(){const e=new Date,t=e.getDay(),s=e.getDate()-t+(0===t?-6:1);return new Date(e.getFullYear(),e.getMonth(),s).getTime()}function i(e,t,s){return e.startTime<s&&e.endTime>t}function r(e,t,s){let n=0;for(const a of e)if(i(a,t,s)){const e=Math.max(a.startTime,t);n+=Math.min(a.endTime,s)-e}return n}function l(e){const[t,s,n]=e.split("-").map(Number);return new Date(t,s-1,n).getTime()}e.exports={formatTime:function(e){e<0&&(e=0);const t=Math.floor(e/1e3),s=Math.floor(t/3600),n=Math.floor(t%3600/60),a=t%60;return`${s.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`},formatTimeHuman:function(e){e<0&&(e=0);const t=Math.floor(e/1e3),s=Math.floor(t/3600),n=Math.floor(t%3600/60),a=t%60,o=[];return s>0&&o.push(`${s}h`),n>0&&o.push(`${n}m`),(a>0||0===o.length)&&o.push(`${a}s`),o.join(" ")},getProjectId:function(){const e=n.workspace.workspaceFolders;if(!e||0===e.length)return"unknown-project";return n.workspace.name||e[0].uri.fsPath},getStartOfDay:a,getStartOfWeek:o,getStartOfMonth:function(){const e=new Date;return new Date(e.getFullYear(),e.getMonth(),1).getTime()},getEndOfDay:function(){return a()+864e5},getEndOfWeek:function(){return o()+6048e5},getEndOfMonth:function(){const e=new Date;return new Date(e.getFullYear(),e.getMonth()+1,1).getTime()},getDateKey:function(e){const t=new Date(e||Date.now());return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`},dateKeyToTimestamp:l,isSessionInRange:i,getTimeInRange:r,getDailyBreakdown:function(e,t=7){const s=[],n=new Date;for(let a=t-1;a>=0;a--){const t=new Date(n.getFullYear(),n.getMonth(),n.getDate()-a),o=t.getTime(),i=o+864e5;s.push({date:t.toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"}),time:r(e,o,i)})}return s},getWeeklyBreakdown:function(e,t=4){const s=[],n=new Date,a=n.getDay(),o=n.getDate()-a+(0===a?-6:1);for(let a=t-1;a>=0;a--){const t=new Date(n.getFullYear(),n.getMonth(),o-7*a),i=new Date(t.getTime()+6048e5);s.push({week:`Week of ${t.toLocaleDateString("en-US",{month:"short",day:"numeric"})}`,time:r(e,t.getTime(),i.getTime())})}return s},getMonthlyBreakdown:function(e,t=6){const s=[],n=new Date;for(let a=t-1;a>=0;a--){const t=new Date(n.getFullYear(),n.getMonth()-a,1),o=new Date(n.getFullYear(),n.getMonth()-a+1,1);s.push({month:t.toLocaleDateString("en-US",{month:"long",year:"numeric"}),time:r(e,t.getTime(),o.getTime())})}return s},aggregateDailyMetrics:function(e,t,s){const n={time:0,keystrokes:0,linesAdded:0,linesDeleted:0,linesAddedBulk:0,linesDeletedBulk:0,charactersAdded:0,charactersDeleted:0};if(!e)return n;for(const[a,o]of Object.entries(e)){const e=l(a);e>=t&&e<s&&(n.time+=o.time||0,n.keystrokes+=o.keystrokes||0,n.linesAdded+=o.linesAdded||0,n.linesDeleted+=o.linesDeleted||0,n.linesAddedBulk+=o.linesAddedBulk||0,n.linesDeletedBulk+=o.linesDeletedBulk||0,n.charactersAdded+=o.charactersAdded||0,n.charactersDeleted+=o.charactersDeleted||0)}return n}}},493(e){class t{constructor(){this.logs=[],this.maxLogs=500,this._syncDetectionCount=0,this._saveCount=0,this._mergeCount=0}log(e,t,s,n=null){const a={timestamp:Date.now(),level:e,category:t,message:s,data:n?this._safeStringify(n):null};this.logs.push(a),this.logs.length>this.maxLogs&&(this.logs=this.logs.slice(-this.maxLogs));const o=`PUNCHCARD [${e.toUpperCase()}] [${t}]`;"error"===e?console.error(o,s,n||""):"warn"===e?console.warn(o,s,n||""):console.log(o,s,n||"")}info(e,t,s){this.log("info",e,t,s)}warn(e,t,s){this.log("warn",e,t,s)}error(e,t,s){this.log("error",e,t,s)}debug(e,t,s){this.log("debug",e,t,s)}recordSyncDetection(){this._syncDetectionCount++}recordSave(){this._saveCount++}recordMerge(){this._mergeCount++}getCounters(){return{syncDetections:this._syncDetectionCount,saves:this._saveCount,merges:this._mergeCount}}getLogs(){return[...this.logs]}getLogsByCategory(e){return this.logs.filter(t=>t.category===e)}getLogsByLevel(e){return this.logs.filter(t=>t.level===e)}clear(){this.logs=[],this.info("init","Logs cleared")}_safeStringify(e){try{return"string"==typeof e?e:JSON.stringify(e,(e,t)=>Array.isArray(t)&&t.length>10?[...t.slice(0,10),`... (${t.length} total)`]:"string"==typeof t&&t.length>200?t.substring(0,200)+"...":t,2)}catch(t){return String(e)}}}const s=new t;e.exports={SyncLogger:t,logger:s}},497(e,t,s){const n=s(398),{Storage:a}=s(829),{Tracker:o}=s(140),{StatusBar:i}=s(523),{StatsWebView:r}=s(103),{logger:l}=s(493);let c,d,h,m;e.exports={activate:async function(e){console.log("PUNCHCARD - Work Time Statistics is now active!"),l.info("init","Extension activating..."),c=new a(e),await c.initialize(),d=new o(c),d.initialize(),h=new i(d),h.initialize(),m=new r(e,c);const t=n.commands.registerCommand("workTimer.showStats",()=>{m.show()}),s=n.commands.registerCommand("workTimer.resetProject",async()=>{const e=d.getProjectId();"Yes, Reset"===await n.window.showWarningMessage(`Are you sure you want to reset statistics for "${e}"?`,{modal:!0},"Yes, Reset")&&(await c.resetProject(e),n.window.showInformationMessage(`Statistics for "${e}" have been reset.`))}),u=n.commands.registerCommand("workTimer.resetAll",async()=>{"Yes, Reset All"===await n.window.showWarningMessage("Are you sure you want to reset ALL statistics? This cannot be undone.",{modal:!0},"Yes, Reset All")&&(await c.resetAll(),n.window.showInformationMessage("All statistics have been reset."))}),g=n.commands.registerCommand("workTimer.exportData",async()=>{const e=c.getAllData(),t=JSON.stringify(e,null,2),s=await n.window.showSaveDialog({defaultUri:n.Uri.file("punchcard-stats.json"),filters:{"JSON Files":["json"]}});s&&(await n.workspace.fs.writeFile(s,Buffer.from(t,"utf8")),n.window.showInformationMessage(`Statistics exported to ${s.fsPath}`))}),p=n.commands.registerCommand("workTimer.importData",async()=>{const e=await n.window.showOpenDialog({canSelectFiles:!0,canSelectFolders:!1,canSelectMany:!1,filters:{"JSON Files":["json"]}});if(e&&e[0])try{const t=await n.workspace.fs.readFile(e[0]),s=JSON.parse(Buffer.from(t).toString("utf8"));s&&s.projects?"Yes, Import"===await n.window.showWarningMessage("This will merge imported data with existing data. Continue?",{modal:!0},"Yes, Import")&&(await c.importData(s),n.window.showInformationMessage("Data imported successfully!")):n.window.showErrorMessage("Invalid data format. Expected a valid PUNCHCARD export file.")}catch(e){n.window.showErrorMessage(`Failed to import data: ${e.message}`)}}),v=n.commands.registerCommand("workTimer.checkSync",async()=>{const e=c.getAllData(),t=Object.keys(e.projects).length,s=e.totalTimeAllProjects,a=["üìä PUNCHCARD Sync Status","",`Projects tracked: ${t}`,`Total time: ${Math.floor(s/36e5)}h ${Math.floor(s%36e5/6e4)}m`,`Total keystrokes: ${e.totalKeystrokes}`,"","‚öôÔ∏è For sync to work:",'1. Settings Sync must be ON (Ctrl+Shift+P ‚Üí "Settings Sync: Turn On")','2. "UI State" must be checked in sync settings',"3. Same Microsoft/GitHub account on both machines",'4. Run "Settings Sync: Sync Now" to force sync',"","Note: Sync may take a few minutes. Reload VS Code after syncing."].join("\n");n.window.showInformationMessage(a,{modal:!0})}),y=n.commands.registerCommand("workTimer.clearSyncLog",()=>{l.clear(),m&&m.panel&&m.update(),n.window.showInformationMessage("PUNCHCARD: Sync log cleared.")}),b=n.commands.registerCommand("workTimer.forceSyncCheck",async()=>{l.info("sync","Manual sync check triggered by user"),await c.checkForSyncedData(),m&&m.panel&&m.update(),n.window.showInformationMessage("PUNCHCARD: Sync check completed. Open statistics to see results.")});e.subscriptions.push(t,s,u,g,p,v,y,b),e.subscriptions.push({dispose:()=>{d.dispose(),h.dispose(),c.dispose(),m.dispose()}}),l.info("init","Extension activated successfully")},deactivate:function(){l.info("init","Extension deactivating..."),c&&(c.flush(),c.dispose()),d&&d.dispose(),h&&h.dispose(),m&&m.dispose()}}},523(e,t,s){const n=s(398),{formatTime:a}=s(413);e.exports={StatusBar:class{constructor(e){this.tracker=e,this.statusBarItem=n.window.createStatusBarItem(n.StatusBarAlignment.Left,100),this.statusBarItem.command="workTimer.showStats",this.statusBarItem.tooltip="Click to view work time statistics",this.updateInterval=null}initialize(){this.statusBarItem.show(),this.update(),this.updateInterval=setInterval(()=>this.update(),1e3),this.tracker.onTimeUpdate(()=>this.update()),this.tracker.onAfkChange(e=>this.updateAfkStatus(e))}update(){const e=this.tracker.getCurrentSessionTime(),t=this.tracker.getTodayTime(),s=this.tracker.isCurrentlyTracking(),o=a(e),i=a(t),r=s?"$(clock)":"$(debug-pause)";this.statusBarItem.text=`${r} ${o} | Today: ${i}`,this.statusBarItem.backgroundColor=s?void 0:new n.ThemeColor("statusBarItem.warningBackground")}updateAfkStatus(e){e?(this.statusBarItem.text=`$(debug-pause) AFK - ${this.statusBarItem.text.split(" | ")[1]||""}`,this.statusBarItem.backgroundColor=new n.ThemeColor("statusBarItem.warningBackground")):(this.statusBarItem.backgroundColor=void 0,this.update())}dispose(){this.updateInterval&&(clearInterval(this.updateInterval),this.updateInterval=null),this.statusBarItem.dispose()}}}},829(e,t,s){const n=s(857),{createEmptyProjectStats:a,createEmptyStorageData:o,createEmptyDailyMetrics:i}=s(305),{logger:r}=s(493),l="punchcard-work-stats",c="punchcard-machine-id",d=[l];e.exports={Storage:class{constructor(e){this.context=e,this.data=o(),this.initialized=!1,this.syncCheckTimeout=null,this.machineId=null,this._lastSaveId=null,this._saveTimer=null,this._periodicSyncInterval=null}async initialize(){this._initMachineId(),r.info("init",`Storage initializing on machine: ${this.machineId}`),this.context.globalState.setKeysForSync(d),r.info("init","Sync keys registered",d),await this.load(),this.initialized=!0,r.info("init",`Storage initialized. Projects: ${Object.keys(this.data.projects).length}, Machine: ${this.machineId}`);const e=Object.values(this.data.projects).reduce((e,t)=>e+(t.sessions||[]).length,0);r.info("init",`Data summary: ${Object.keys(this.data.projects).length} projects, ${e} total sessions, totalTime: ${this.data.totalTimeAllProjects}ms`),this.data._machineId&&this.data._machineId!==this.machineId&&r.warn("sync",`Loaded data originated from different machine: ${this.data._machineId} (we are ${this.machineId})`),this.scheduleSyncCheck(),this._startPeriodicSyncCheck()}scheduleSyncCheck(){[5e3,15e3,3e4].forEach(e=>{setTimeout(async()=>{r.debug("sync",`Running scheduled sync check (${e}ms delay)`),await this.checkForSyncedData()},e)})}_startPeriodicSyncCheck(){this._periodicSyncInterval=setInterval(async()=>{r.debug("sync","Running periodic sync check"),await this.checkForSyncedData()},6e4)}_initMachineId(){let e=this.context.globalState.get(c);e?r.info("init",`Using existing machine ID: ${e}`):(e=`${n.hostname()}-${Date.now().toString(36)}-${Math.random().toString(36).substring(2,6)}`,this.context.globalState.update(c,e),r.info("init",`Generated new machine ID: ${e}`)),this.machineId=e}_getDateKey(e){const t=new Date(e||Date.now());return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}async checkForSyncedData(){const e=this.context.globalState.get(l);if(!e||!e.projects)return void r.debug("sync","No stored data found in globalState");if(e._saveId&&e._saveId!==this._lastSaveId)return r.info("sync","Detected data change via _saveId mismatch",{ourLastSaveId:this._lastSaveId,storedSaveId:e._saveId,storedMachineId:e._machineId,ourMachineId:this.machineId}),r.recordSyncDetection(),this.mergeWithSyncedData(e),void await this._saveImmediate();let t=!1,s="";for(const n in e.projects){if(!this.data.projects[n]){t=!0,s=`New project from sync: ${n}`;break}const a=e.projects[n].sessions||[],o=this.data.projects[n].sessions||[],i=new Set(o.map(e=>e.startTime));for(const e of a){if(!i.has(e.startTime)){t=!0,s=`New session in ${n} (startTime: ${e.startTime})`;break}const a=o.find(t=>t.startTime===e.startTime);if(a&&(e.duration||0)>(a.duration||0)){t=!0,s=`Updated session in ${n} (longer duration)`;break}}if(t)break}t?(r.info("sync",`Sync merge needed: ${s}`),r.recordSyncDetection(),this.mergeWithSyncedData(e),await this._saveImmediate()):r.debug("sync","Sync check complete - no new data detected")}mergeWithSyncedData(e){r.info("merge","Starting merge with synced data",{syncedProjects:Object.keys(e.projects||{}),currentProjects:Object.keys(this.data.projects||{}),syncedMachineId:e._machineId,ourMachineId:this.machineId});let t=0,s=0,n=0;for(const a in e.projects){const o=e.projects[a];if(this.data.projects[a]){const e=this.data.projects[a],t=(e.sessions||[]).length,i=(o.sessions||[]).length,l=this.mergeSessions(e.sessions||[],o.sessions||[]),c=l.length-t;n+=Math.max(0,c);const d=l.reduce((e,t)=>e+(t.duration||0),0);this.data.projects[a]={totalTime:d,linesAdded:Math.max(e.linesAdded||0,o.linesAdded||0),linesDeleted:Math.max(e.linesDeleted||0,o.linesDeleted||0),linesAddedBulk:Math.max(e.linesAddedBulk||0,o.linesAddedBulk||0),linesDeletedBulk:Math.max(e.linesDeletedBulk||0,o.linesDeletedBulk||0),charactersAdded:Math.max(e.charactersAdded||0,o.charactersAdded||0),charactersDeleted:Math.max(e.charactersDeleted||0,o.charactersDeleted||0),keystrokes:Math.max(e.keystrokes||0,o.keystrokes||0),sessions:l,lastActive:Math.max(e.lastActive||0,o.lastActive||0),dailyMetrics:this._mergeDailyMetrics(e.dailyMetrics||{},o.dailyMetrics||{})},s++,c>0&&r.info("merge",`Merged project ${a}: +${c} sessions (${t} + ${i} synced ‚Üí ${l.length} merged)`)}else this.data.projects[a]=o,t++,r.info("merge",`New project from sync: ${a}`,{sessions:(o.sessions||[]).length,totalTime:o.totalTime})}this.recalculateTotals(),r.recordMerge(),r.info("merge",`Merge complete: ${t} new projects, ${s} merged projects, ${n} new sessions`)}mergeSessions(e,t){const s=new Map;for(const t of e)s.set(t.startTime,t);let n=0,a=0;for(const e of t){const t=s.get(e.startTime);t?(e.duration||0)>(t.duration||0)&&(s.set(e.startTime,e),n++):(s.set(e.startTime,e),a++)}return(a>0||n>0)&&r.debug("merge",`Session merge: ${a} new, ${n} replaced (longer duration)`),Array.from(s.values()).sort((e,t)=>e.startTime-t.startTime)}_mergeDailyMetrics(e,t){const s={...e};for(const e in t)if(s[e]){const n=s[e],a=t[e];s[e]={time:Math.max(n.time||0,a.time||0),keystrokes:Math.max(n.keystrokes||0,a.keystrokes||0),linesAdded:Math.max(n.linesAdded||0,a.linesAdded||0),linesDeleted:Math.max(n.linesDeleted||0,a.linesDeleted||0),linesAddedBulk:Math.max(n.linesAddedBulk||0,a.linesAddedBulk||0),linesDeletedBulk:Math.max(n.linesDeletedBulk||0,a.linesDeletedBulk||0),charactersAdded:Math.max(n.charactersAdded||0,a.charactersAdded||0),charactersDeleted:Math.max(n.charactersDeleted||0,a.charactersDeleted||0)}}else s[e]={...t[e]};return s}recalculateTotals(){const e=this.data.totalTimeAllProjects;this.data.totalTimeAllProjects=0,this.data.totalKeystrokes=0;for(const e in this.data.projects){const t=this.data.projects[e],s=(t.sessions||[]).reduce((e,t)=>e+(t.duration||0),0);t.totalTime=s,this.data.totalTimeAllProjects+=s,this.data.totalKeystrokes+=t.keystrokes||0}e!==this.data.totalTimeAllProjects&&r.debug("storage",`Totals recalculated: ${e}ms ‚Üí ${this.data.totalTimeAllProjects}ms (delta: ${this.data.totalTimeAllProjects-e}ms)`)}async load(){const e=this.context.globalState.get(l);e?(this.data={projects:e.projects||{},totalTimeAllProjects:e.totalTimeAllProjects||0,totalKeystrokes:e.totalKeystrokes||0,_saveId:e._saveId||null,_machineId:e._machineId||null,_lastSaveTime:e._lastSaveTime||null},this._lastSaveId=e._saveId||null,r.info("storage","Loaded existing data from globalState",{projects:Object.keys(this.data.projects).length,totalTime:this.data.totalTimeAllProjects,loadedSaveId:this._lastSaveId,loadedMachineId:this.data._machineId})):(this.data=o(),this._lastSaveId=null,r.info("storage","No existing data found, starting fresh"))}async save(){try{const e=this.context.globalState.get(l);e&&e._saveId&&e._saveId!==this._lastSaveId&&(r.warn("sync","SYNC DETECTED: globalState was modified by another source (Settings Sync)",{ourLastSaveId:this._lastSaveId,storedSaveId:e._saveId,storedMachineId:e._machineId,ourMachineId:this.machineId}),r.recordSyncDetection(),this.mergeWithSyncedData(e))}catch(e){r.error("storage",`Error during pre-save sync check: ${e.message}`)}this._lastSaveId=`${this.machineId}-${Date.now()}`,this.data._saveId=this._lastSaveId,this.data._machineId=this.machineId,this.data._lastSaveTime=Date.now(),await this.context.globalState.update(l,this.data),r.recordSave()}_scheduleSave(){this._saveTimer||(this._saveTimer=setTimeout(async()=>{this._saveTimer=null,await this.save()},1e4))}async _saveImmediate(){this._saveTimer&&(clearTimeout(this._saveTimer),this._saveTimer=null),await this.save()}async flush(){this._saveTimer&&(clearTimeout(this._saveTimer),this._saveTimer=null,await this.save(),r.info("storage","Flushed pending save on deactivation"))}getProjectStats(e){this.data.projects[e]||(this.data.projects[e]=a());const t=this.data.projects[e];return t.dailyMetrics||(t.dailyMetrics={}),t}async updateProjectStats(e,t){const s=this.getProjectStats(e);Object.assign(s,t),await this.save()}async addTime(e,t){const s=this.getProjectStats(e);s.totalTime+=t,s.lastActive=Date.now(),this.data.totalTimeAllProjects+=t;const n=this._getDateKey();s.dailyMetrics[n]||(s.dailyMetrics[n]=i()),s.dailyMetrics[n].time+=t,this._scheduleSave()}async addSession(e,t){const s=this.getProjectStats(e);t.machineId=this.machineId,s.sessions.push(t),r.info("session",`New session started for ${e}`,{startTime:t.startTime,machineId:this.machineId}),await this.save()}async updateLastSession(e,t,s,n){const a=this.getProjectStats(e);if(a.sessions.length>0){const o=a.sessions.find(e=>e.startTime===t);if(o)o.endTime=s,o.duration=n,this._scheduleSave();else{const o=a.sessions.filter(e=>!e.machineId||e.machineId===this.machineId).pop();o?(o.endTime=s,o.duration=n,this._scheduleSave(),r.warn("session",`Session not found by startTime ${t}, used fallback (last session from this machine)`)):r.error("session",`Could not find session to update for ${e} (startTime: ${t})`)}}}async addMetrics(e,t){const s=this.getProjectStats(e),n=this._getDateKey();s.dailyMetrics[n]||(s.dailyMetrics[n]=i());const a=s.dailyMetrics[n];t.linesAdded&&(s.linesAdded+=t.linesAdded,a.linesAdded+=t.linesAdded),t.linesDeleted&&(s.linesDeleted+=t.linesDeleted,a.linesDeleted+=t.linesDeleted),t.linesAddedBulk&&("number"!=typeof s.linesAddedBulk&&(s.linesAddedBulk=0),s.linesAddedBulk+=t.linesAddedBulk,a.linesAddedBulk+=t.linesAddedBulk),t.linesDeletedBulk&&("number"!=typeof s.linesDeletedBulk&&(s.linesDeletedBulk=0),s.linesDeletedBulk+=t.linesDeletedBulk,a.linesDeletedBulk+=t.linesDeletedBulk),t.charactersAdded&&(s.charactersAdded+=t.charactersAdded,a.charactersAdded+=t.charactersAdded),t.charactersDeleted&&(s.charactersDeleted+=t.charactersDeleted,a.charactersDeleted+=t.charactersDeleted),t.keystrokes&&(s.keystrokes+=t.keystrokes,this.data.totalKeystrokes+=t.keystrokes,a.keystrokes+=t.keystrokes),s.lastActive=Date.now(),this._scheduleSave()}async resetProjectStat(e,t){if(!this.data.projects[e])return;const s=this.data.projects[e];switch(t){case"keystrokes":this.data.totalKeystrokes-=s.keystrokes||0,s.keystrokes=0;break;case"linesAdded":s.linesAdded=0;break;case"linesDeleted":s.linesDeleted=0;break;case"linesAddedBulk":s.linesAddedBulk=0;break;case"linesDeletedBulk":s.linesDeletedBulk=0;break;case"charactersAdded":s.charactersAdded=0;break;case"charactersDeleted":s.charactersDeleted=0;break;case"totalTime":this.data.totalTimeAllProjects-=s.totalTime||0,s.totalTime=0;break;case"sessions":s.sessions=[];break;case"allLines":s.linesAdded=0,s.linesDeleted=0,s.linesAddedBulk=0,s.linesDeletedBulk=0;break;case"allChars":s.charactersAdded=0,s.charactersDeleted=0;break;case"dailyMetrics":s.dailyMetrics={}}await this.save()}async resetGlobalStat(e){for(const t in this.data.projects){const s=this.data.projects[t];switch(e){case"keystrokes":s.keystrokes=0;break;case"linesAdded":s.linesAdded=0;break;case"linesDeleted":s.linesDeleted=0;break;case"linesAddedBulk":s.linesAddedBulk=0;break;case"linesDeletedBulk":s.linesDeletedBulk=0;break;case"charactersAdded":s.charactersAdded=0;break;case"charactersDeleted":s.charactersDeleted=0;break;case"totalTime":s.totalTime=0;break;case"sessions":s.sessions=[]}}"keystrokes"===e&&(this.data.totalKeystrokes=0),"totalTime"===e&&(this.data.totalTimeAllProjects=0),await this.save()}async resetProject(e){if(this.data.projects[e]){const t=this.data.projects[e];this.data.totalTimeAllProjects-=t.totalTime,this.data.totalKeystrokes-=t.keystrokes,delete this.data.projects[e],await this.save()}}async resetAll(){this.data=o(),await this.save()}async importData(e){if(!e||!e.projects)throw new Error("Invalid data format");r.info("storage","Importing data",{projectCount:Object.keys(e.projects).length});for(const t in e.projects){const s=e.projects[t];if(this.data.projects[t]){const e=this.data.projects[t],n=this.mergeSessions(e.sessions||[],s.sessions||[]),a=n.reduce((e,t)=>e+(t.duration||0),0);this.data.projects[t]={totalTime:a,linesAdded:Math.max(e.linesAdded||0,s.linesAdded||0),linesDeleted:Math.max(e.linesDeleted||0,s.linesDeleted||0),linesAddedBulk:Math.max(e.linesAddedBulk||0,s.linesAddedBulk||0),linesDeletedBulk:Math.max(e.linesDeletedBulk||0,s.linesDeletedBulk||0),charactersAdded:Math.max(e.charactersAdded||0,s.charactersAdded||0),charactersDeleted:Math.max(e.charactersDeleted||0,s.charactersDeleted||0),keystrokes:Math.max(e.keystrokes||0,s.keystrokes||0),sessions:n,lastActive:Math.max(e.lastActive||0,s.lastActive||0),dailyMetrics:this._mergeDailyMetrics(e.dailyMetrics||{},s.dailyMetrics||{})}}else this.data.projects[t]=s}this.data.totalTimeAllProjects=0,this.data.totalKeystrokes=0;for(const e in this.data.projects)this.data.totalTimeAllProjects+=this.data.projects[e].totalTime||0,this.data.totalKeystrokes+=this.data.projects[e].keystrokes||0;await this.save()}getAllData(){const{_saveId:e,_machineId:t,_lastSaveTime:s,...n}=this.data;return{...n}}getSyncInfo(){const e=r.getCounters(),t=Object.values(this.data.projects).reduce((e,t)=>e+(t.sessions||[]).length,0),s={};for(const e in this.data.projects)for(const t of this.data.projects[e].sessions||[]){const e=t.machineId||"unknown";s[e]=(s[e]||0)+1}return{machineId:this.machineId,lastSaveId:this._lastSaveId,lastSaveTime:this.data._lastSaveTime,savedMachineId:this.data._machineId,syncDetections:e.syncDetections,totalSaves:e.saves,totalMerges:e.merges,projectCount:Object.keys(this.data.projects).length,totalSessions:t,sessionsByMachine:s}}dispose(){this._saveTimer&&(clearTimeout(this._saveTimer),this._saveTimer=null),this._periodicSyncInterval&&(clearInterval(this._periodicSyncInterval),this._periodicSyncInterval=null)}getSummary(){const e=Object.keys(this.data.projects).length;let t=0,s=0,n=0,a=0,o=0,i=0,r=0;for(const e in this.data.projects){const l=this.data.projects[e];t+=l.sessions.length,s+=l.linesAdded||0,n+=l.linesDeleted||0,a+=l.linesAddedBulk||0,o+=l.linesDeletedBulk||0,i+=l.charactersAdded||0,r+=l.charactersDeleted||0}return{projectCount:e,totalTime:this.data.totalTimeAllProjects,totalKeystrokes:this.data.totalKeystrokes,totalSessions:t,totalLinesAdded:s,totalLinesDeleted:n,totalLinesAddedBulk:a,totalLinesDeletedBulk:o,totalCharsAdded:i,totalCharsDeleted:r}}},STORAGE_KEY:l}},857(e){"use strict";e.exports=require("os")}},t={},s=function s(n){var a=t[n];if(void 0!==a)return a.exports;var o=t[n]={exports:{}};return e[n](o,o.exports,s),o.exports}(497);module.exports=s})();